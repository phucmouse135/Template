<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Garden Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icon Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .metric-card { text-align: center; padding: 20px; }
        .metric-value { font-size: 2.5rem; font-weight: bold; color: #333; }
        .metric-unit { font-size: 1rem; color: #777; }
        .metric-icon { font-size: 2rem; margin-bottom: 10px; }

        /* Màu sắc cho các chỉ số */
        .temp-color { color: #ff6384; }
        .humid-color { color: #36a2eb; }
        .soil-color { color: #4bc0c0; }
        .light-color { color: #ffcd56; }

        .status-dot { height: 12px; width: 12px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
        .status-offline { background-color: #dc3545; }

        #loading { display: none; }
        .error-msg { display: none; }
    </style>
</head>
<body>

<div class="container mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success"><i class="bi bi-flower1"></i> Smart Garden Dashboard</h2>
        <div>
            <span id="connectionStatus" class="badge bg-secondary">Đang kết nối...</span>
        </div>
    </div>

    <!-- Bộ lọc -->
    <div class="card p-4 mb-4">
        <div class="alert alert-danger error-msg" id="globalError"></div>
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-bold">Chọn thiết bị:</label>
                <select id="deviceSelect" class="form-select" onchange="onDeviceChange()">
                    <option value="" disabled selected>Đang tải danh sách...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Từ ngày:</label>
                <input type="datetime-local" id="fromDate" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">Đến ngày:</label>
                <input type="datetime-local" id="toDate" class="form-control">
            </div>
            <div class="col-md-2">
                <button onclick="loadHistoryData()" class="btn btn-success w-100 fw-bold">
                    <span id="loading" class="spinner-border spinner-border-sm me-1"></span> Xem Lịch Sử
                </button>
            </div>
        </div>
    </div>

    <!-- Phần Hiển thị Thời gian thực (NEW) -->
    <div class="row mb-4">
        <div class="col-12 mb-2">
            <h5 class="fw-bold text-secondary">
                <span id="deviceStatusDot" class="status-dot"></span>
                Trạng thái hiện tại <small class="text-muted fw-normal" style="font-size: 0.8rem">(Cập nhật mỗi 5s)</small>
            </h5>
        </div>
        <!-- Nhiệt độ -->
        <div class="col-md-3 col-6 mb-3">
            <div class="card metric-card">
                <div class="metric-icon temp-color"><i class="bi bi-thermometer-half"></i></div>
                <div class="text-muted">Nhiệt độ</div>
                <div><span class="metric-value" id="rt_temp">--</span> <span class="metric-unit">°C</span></div>
            </div>
        </div>
        <!-- Độ ẩm KK -->
        <div class="col-md-3 col-6 mb-3">
            <div class="card metric-card">
                <div class="metric-icon humid-color"><i class="bi bi-droplet-fill"></i></div>
                <div class="text-muted">Độ ẩm KK</div>
                <div><span class="metric-value" id="rt_humid">--</span> <span class="metric-unit">%</span></div>
            </div>
        </div>
        <!-- Độ ẩm Đất -->
        <div class="col-md-3 col-6 mb-3">
            <div class="card metric-card">
                <div class="metric-icon soil-color"><i class="bi bi-water"></i></div>
                <div class="text-muted">Độ ẩm Đất</div>
                <div><span class="metric-value" id="rt_soil">--</span> <span class="metric-unit">%</span></div>
            </div>
        </div>
        <!-- Ánh sáng -->
        <div class="col-md-3 col-6 mb-3">
            <div class="card metric-card">
                <div class="metric-icon light-color"><i class="bi bi-brightness-high-fill"></i></div>
                <div class="text-muted">Ánh sáng</div>
                <div><span class="metric-value" id="rt_light">--</span> <span class="metric-unit">Lux</span></div>
            </div>
        </div>
    </div>

    <!-- Biểu đồ -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card p-3 h-100">
                <h5 class="card-title text-center fw-bold text-secondary">Biểu đồ Nhiệt độ & Độ ẩm</h5>
                <canvas id="tempChart"></canvas>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card p-3 h-100">
                <h5 class="card-title text-center fw-bold text-secondary">Biểu đồ Đất & Ánh sáng</h5>
                <canvas id="soilChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = "http://localhost:8080/api/v1/devices";
    let chart1 = null;
    let chart2 = null;
    let realtimeInterval = null; // Biến để lưu vòng lặp cập nhật

    document.addEventListener("DOMContentLoaded", async () => {
        if (typeof Chart === 'undefined') {
            showError("Lỗi: Không tải được thư viện Chart.js.");
            return;
        }
        setDefaultDates();
        await loadDevices();
    });

    function showError(msg) {
        const errDiv = document.getElementById("globalError");
        errDiv.textContent = msg;
        errDiv.style.display = "block";
    }

    function setDefaultDates() {
        const now = new Date();
        const yesterday = new Date();
        yesterday.setDate(now.getDate() - 1);
        const toLocal = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

        document.getElementById("toDate").value = toLocal(now);
        document.getElementById("fromDate").value = toLocal(yesterday);
    }

    async function loadDevices() {
        try {
            const response = await fetch(API_BASE_URL);
            if (!response.ok) throw new Error("Không lấy được danh sách thiết bị");
            const result = await response.json();

            const select = document.getElementById("deviceSelect");
            select.innerHTML = "";

            if (result.data && result.data.length > 0) {
                result.data.forEach(device => {
                    const option = document.createElement("option");
                    option.value = device.device_uid;
                    option.text = `${device.name} (${device.device_uid})`;
                    select.appendChild(option);
                });
                // Khi load xong, tự động chọn thiết bị đầu tiên và bắt đầu
                onDeviceChange();
            } else {
                select.innerHTML = "<option>Không tìm thấy thiết bị nào</option>";
            }
        } catch (error) {
            console.error(error);
            showError("Không kết nối được tới Server Backend.");
        }
    }

    // Hàm được gọi khi đổi thiết bị ở dropdown
    function onDeviceChange() {
        const deviceUid = document.getElementById("deviceSelect").value;
        if (!deviceUid) return;

        // 1. Tải dữ liệu lịch sử (Biểu đồ)
        loadHistoryData();

        // 2. Bắt đầu theo dõi thời gian thực
        startRealtimeMonitoring(deviceUid);
    }

    // --- LOGIC REAL-TIME MỚI ---
    function startRealtimeMonitoring(deviceUid) {
        // Xóa interval cũ nếu có (để tránh chạy trùng lặp)
        if (realtimeInterval) clearInterval(realtimeInterval);

        // Gọi ngay lập tức lần đầu
        fetchRealtimeData(deviceUid);

        // Cài đặt lặp lại mỗi 5 giây
        realtimeInterval = setInterval(() => {
            fetchRealtimeData(deviceUid);
        }, 5000);
    }

    async function fetchRealtimeData(deviceUid) {
        try {
            // Gọi API lấy trạng thái tức thời
            const response = await fetch(`${API_BASE_URL}/${deviceUid}/state`);
            if (!response.ok) return;

            const result = await response.json();
            const state = result.data;

            // Cập nhật giao diện
            updateRealtimeUI(state);

        } catch (error) {
            console.error("Lỗi cập nhật Realtime:", error);
        }
    }

    function updateRealtimeUI(state) {
        // 1. Cập nhật trạng thái Online/Offline
        const statusDot = document.getElementById("deviceStatusDot");
        const connStatus = document.getElementById("connectionStatus");

        if (state.status && state.status.toLowerCase() === 'online') {
            statusDot.className = "status-dot status-online";
            connStatus.className = "badge bg-success";
            connStatus.textContent = "Thiết bị Online";
        } else {
            statusDot.className = "status-dot status-offline";
            connStatus.className = "badge bg-danger";
            connStatus.textContent = "Thiết bị Offline";
        }

        // 2. Cập nhật các chỉ số cảm biến (nếu có)
        if (state.sensors) {
            // Sử dụng cú pháp ?. để tránh lỗi nếu dữ liệu null
            // Chú ý: Tên trường phải khớp với JSON trả về (snake_case hay camelCase tùy cấu hình Jackson)
            // Ở đây mình check cả 2 trường hợp cho chắc
            const temp = state.sensors.temperature ?? state.sensors.Temperature ?? "--";
            const humid = state.sensors.air_humidity ?? state.sensors.airHumidity ?? "--";
            const soil = state.sensors.soil_moisture ?? state.sensors.soilMoisture ?? "--";
            const light = state.sensors.light ?? state.sensors.light_level ?? "--";

            document.getElementById("rt_temp").textContent = temp;
            document.getElementById("rt_humid").textContent = humid;
            document.getElementById("rt_soil").textContent = soil;
            document.getElementById("rt_light").textContent = light;
        }
    }

    // --- LOGIC BIỂU ĐỒ (GIỮ NGUYÊN) ---
    async function loadHistoryData() {
        const deviceUid = document.getElementById("deviceSelect").value;
        if (!deviceUid) return;

        const fromDate = new Date(document.getElementById("fromDate").value);
        const toDate = new Date(document.getElementById("toDate").value);

        const fromIso = fromDate.toISOString();
        const toIso = toDate.toISOString();

        document.getElementById("loading").style.display = "inline-block";
        document.getElementById("globalError").style.display = "none";

        try {
            const url = `${API_BASE_URL}/${deviceUid}/history?from=${encodeURIComponent(fromIso)}&to=${encodeURIComponent(toIso)}`;
            const response = await fetch(url);

            if (response.status === 400) throw new Error("Lỗi 400: Sai định dạng ngày tháng.");
            if (!response.ok) throw new Error(`Lỗi Server: ${response.status}`);

            const result = await response.json();
            if(result.code === 200) {
                renderCharts(result.data);
            } else {
                showError(result.message);
            }
        } catch (error) {
            console.error("Lỗi tải history:", error);
            showError(error.message);
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    function renderCharts(data) {
        if (!data || data.length === 0) {
            if (chart1) chart1.destroy();
            if (chart2) chart2.destroy();
            return;
        }

        const labels = data.map(log => log.log_time);
        const tempData = data.map(log => log.temperature);
        const humidData = data.map(log => log.air_humidity);
        const soilData = data.map(log => log.soil_moisture);
        const lightData = data.map(log => log.light_level !== null ? log.light_level : 0);

        if (chart1) chart1.destroy();
        if (chart2) chart2.destroy();

        const ctx1 = document.getElementById('tempChart').getContext('2d');
        chart1 = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Nhiệt độ (°C)', data: tempData, borderColor: '#ff6384', tension: 0.4 },
                    { label: 'Độ ẩm KK (%)', data: humidData, borderColor: '#36a2eb', tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                scales: { x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } } }
            }
        });

        const ctx2 = document.getElementById('soilChart').getContext('2d');
        chart2 = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Độ ẩm đất (%)', data: soilData, borderColor: '#4bc0c0', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.4 },
                    { label: 'Ánh sáng (Lux)', data: lightData, borderColor: '#ffcd56', tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                scales: { x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } } }
            }
        });
    }
</script>
</body>
</html>